# Архитектура системы "Тайный Санта OVERSUN"

## 1. Общее описание

Веб-приложение для проведения корпоративной новогодней игры "Тайный Санта" с разделением ролей пользователей и административным контролем.

## 2. Архитектура системы

### 2.1 Технологический стек
- **Backend**: Flask (Python)
- **Frontend**: HTML5, CSS3, JavaScript (Vanilla)
- **База данных**: SQLite
- **Архитектура**: MVC (Model-View-Controller)

### 2.2 Структура проекта
```
тайный санта/
├── app.py                 # Главный файл Flask приложения
├── database.py            # Модели и работа с БД
├── config.py              # Конфигурация (админ-код, настройки)
├── static/
│   ├── css/
│   │   └── style.css      # Стили приложения
│   └── js/
│       └── main.js        # Клиентский JavaScript
├── templates/
│   ├── index.html         # Главная страница
│   ├── register.html      # Регистрация участника
│   ├── participant.html   # Личный кабинет участника
│   ├── admin.html         # Административная панель
│   └── error.html         # Страница ошибки
├── requirements.txt       # Зависимости Python
└── README.md              # Инструкции по запуску
```

## 3. Роли пользователей

### 3.1 Обычный пользователь (Сотрудник)
- **Права доступа**: Просмотр главной страницы, регистрация, просмотр своего результата
- **Функции**:
  - Регистрация в системе
  - Указание пожеланий к подарку
  - Просмотр информации о получателе подарка (после жеребьёвки)
- **Ограничения**: Не видит других участников, не может изменять данные после жеребьёвки

### 3.2 Администратор
- **Права доступа**: Полный доступ ко всем функциям системы
- **Функции**:
  - Просмотр списка всех участников
  - Управление этапами игры
  - Запуск жеребьёвки
  - Просмотр всех пар распределения
  - Сброс игры
- **Аутентификация**: Простой код администратора (хранится в config.py)

## 4. Модель данных

### 4.1 Таблица `participants`
- `id` (INTEGER, PRIMARY KEY)
- `name` (TEXT, NOT NULL) - Имя и фамилия
- `email` (TEXT, UNIQUE, NOT NULL) - Email/ID
- `wishlist` (TEXT) - Пожелания к подарку
- `recipient_id` (INTEGER, FOREIGN KEY) - ID получателя подарка
- `registered_at` (TIMESTAMP) - Дата регистрации

### 4.2 Таблица `game_state`
- `id` (INTEGER, PRIMARY KEY)
- `status` (TEXT) - Статус игры: 'registration', 'completed', 'reset'
- `drawn_at` (TIMESTAMP) - Дата проведения жеребьёвки

## 5. Алгоритм распределения

### 5.1 Требования
- Случайное распределение участников
- Исключение самоназначения (участник не дарит себе)
- Уникальность пар (каждый дарит только одному)
- Каждый участник получает подарок от одного человека

### 5.2 Реализация
Используется алгоритм циклической перестановки с проверкой:
1. Создается список всех участников
2. Создается перестановка списка
3. Проверяется отсутствие самоназначения
4. Если есть самоназначение - повторная перестановка
5. Сохранение пар в БД

## 6. API Endpoints

### 6.1 Публичные endpoints
- `GET /` - Главная страница
- `GET /register` - Страница регистрации
- `POST /register` - Регистрация участника
- `GET /participant/<email>` - Личный кабинет участника
- `POST /participant/check` - Проверка регистрации по email

### 6.2 Административные endpoints
- `GET /admin` - Страница входа администратора
- `POST /admin/login` - Вход администратора
- `GET /admin/dashboard` - Административная панель
- `GET /api/admin/participants` - Список всех участников (JSON)
- `GET /api/admin/game-state` - Статус игры (JSON)
- `POST /api/admin/draw` - Запуск жеребьёвки
- `POST /api/admin/reset` - Сброс игры

## 7. Безопасность

### 7.1 Защита административной панели
- Проверка кода администратора при каждом запросе
- Сессионное хранение статуса администратора
- Валидация всех административных действий

### 7.2 Защита данных
- Защита от повторного запуска жеребьёвки
- Защита от изменения данных после жеребьёвки
- Валидация входных данных

## 8. Этапы игры

1. **Регистрация** (`status: 'registration'`)
   - Участники регистрируются в системе
   - Администратор видит список участников

2. **Жеребьёвка** (`status: 'completed'`)
   - Администратор запускает распределение
   - Участники получают доступ к своим результатам

3. **Сброс** (`status: 'reset'`)
   - Администратор может сбросить игру
   - Все данные очищаются

