<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - –¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞ OVERSUN</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        {% if login_page %}
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ -->
        <header class="main-header">
            <h1 class="title">üîê –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <a href="{{ url_for('index') }}" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </header>

        <main class="main-content">
            <section class="admin-login-section">
                {% if error %}
                <div class="alert alert-error">{{ error }}</div>
                {% endif %}

                <form method="POST" action="{{ url_for('admin_login_post') }}" class="admin-login-form">
                    <div class="form-group">
                        <label for="code">–ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                        <input type="password" 
                               id="code" 
                               name="code" 
                               required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞"
                               autofocus>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large">
                        –í–æ–π—Ç–∏
                    </button>
                </form>
            </section>
        </main>
        {% else %}
        <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <header class="admin-header">
            <h1 class="title">üîê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
            <div class="admin-actions">
                <a href="{{ url_for('index') }}" class="btn btn-outline">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
            </div>
        </header>

        <main class="main-content">
            <!-- –°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã -->
            <section class="admin-section">
                <h2>üìä –°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</h2>
                <div class="status-display">
                    {% if game_state.status == 'registration' %}
                    <span class="status-badge status-open">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞</span>
                    {% elif game_state.status == 'completed' %}
                    <span class="status-badge status-completed">–ñ–µ—Ä–µ–±—å—ë–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                    {% if game_state.drawn_at %}
                    <p class="status-time">–ü—Ä–æ–≤–µ–¥–µ–Ω–∞: {{ game_state.drawn_at }}</p>
                    {% endif %}
                    {% else %}
                    <span class="status-badge status-reset">–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞</span>
                    {% endif %}
                </div>
            </section>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π -->
            <section class="admin-section">
                <h2>üé≤ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π</h2>
                <div class="game-controls">
                    <!-- –õ–∏–º–∏—Ç —Ü–µ–Ω—ã -->
                    <div class="price-limit-control">
                        <label for="priceLimit">üí∞ –õ–∏–º–∏—Ç —Ü–µ–Ω—ã –ø–æ–¥–∞—Ä–∫–∞ (—Ä—É–±.):</label>
                        <div class="price-limit-input-group">
                            <input type="number" 
                                   id="priceLimit" 
                                   min="0" 
                                   step="100" 
                                   value="{{ game_state.price_limit or '' }}" 
                                   placeholder="–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω">
                            <button id="setPriceLimitBtn" class="btn btn-outline">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                        <div id="priceLimitResult" class="action-result"></div>
                        {% if game_state.price_limit %}
                        <p class="current-limit">–¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç: <strong>{{ game_state.price_limit }} —Ä—É–±.</strong></p>
                        {% endif %}
                    </div>
                    
                    {% if game_state.status == 'registration' %}
                    <button id="drawBtn" class="btn btn-primary btn-large">
                        üé≤ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∂–µ—Ä–µ–±—å—ë–≤–∫—É
                    </button>
                    <div id="drawResult" class="action-result"></div>
                    {% endif %}
                    
                    <button id="resetBtn" class="btn btn-danger btn-large">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É
                    </button>
                    <div id="resetResult" class="action-result"></div>
                </div>
            </section>

            <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <section class="admin-section">
                <h2>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ participants|length }})</h2>
                {% if participants %}
                <div class="participants-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>Email</th>
                                <th>–ü–æ–∂–µ–ª–∞–Ω–∏—è</th>
                                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in participants %}
                            <tr>
                                <td>{{ p.id }}</td>
                                <td>{{ p.name }}</td>
                                <td>{{ p.email }}</td>
                                <td>
                                    {% if p.wishlist %}
                                    <span class="has-wishlist" title="{{ p.wishlist }}">‚úì</span>
                                    {% else %}
                                    <span class="no-wishlist">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>{{ p.registered_at }}</td>
                                <td>
                                    <button class="btn-edit" onclick="editParticipant({{ p.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        ‚úèÔ∏è
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="empty-state">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</p>
                {% endif %}
            </section>

            <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä -->
            {% if game_state.status == 'completed' and pairs %}
            <section class="admin-section">
                <h2>üéÅ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä</h2>
                <div class="pairs-grid">
                    {% for pair in pairs %}
                    <div class="pair-card">
                        <div class="pair-giver">
                            <span class="pair-label">–î–∞—Ä–∏—Ç:</span>
                            <span class="pair-name">{{ pair.giver.name }}</span>
                            <span class="pair-email">({{ pair.giver.email }})</span>
                        </div>
                        <div class="pair-arrow">‚Üí</div>
                        <div class="pair-recipient">
                            <span class="pair-label">–ü–æ–ª—É—á–∞–µ—Ç:</span>
                            <span class="pair-name">{{ pair.recipient.name }}</span>
                            <span class="pair-email">({{ pair.recipient.email }})</span>
                            {% if pair.recipient.wishlist %}
                            <div class="pair-wishlist">
                                <strong>–ü–æ–∂–µ–ª–∞–Ω–∏—è:</strong> {{ pair.recipient.wishlist }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </main>
        {% endif %}
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
            <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <form id="editParticipantForm">
                <input type="hidden" id="editParticipantId">
                <div class="form-group">
                    <label for="editName">–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è *</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email / –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID *</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label for="editWishlist">–ü–æ–∂–µ–ª–∞–Ω–∏—è –∫ –ø–æ–¥–∞—Ä–∫—É</label>
                    <textarea id="editWishlist" rows="4"></textarea>
                </div>
                <div id="editResult" class="action-result"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% if not login_page %}
    <script>
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∂–µ—Ä–µ–±—å—ë–≤–∫–∏
        document.getElementById('drawBtn')?.addEventListener('click', async function() {
            const resultDiv = document.getElementById('drawResult');
            resultDiv.innerHTML = '<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∂–µ—Ä–µ–±—å—ë–≤–∫–∞...</p>';
            
            try {
                const response = await fetch('/api/admin/draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∂–µ—Ä–µ–±—å—ë–≤–∫–∏</p>';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞
        document.getElementById('resetBtn')?.addEventListener('click', async function() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                return;
            }
            
            const resultDiv = document.getElementById('resetResult');
            resultDiv.innerHTML = '<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–±—Ä–æ—Å...</p>';
            
            try {
                const response = await fetch('/api/admin/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∏–≥—Ä—ã</p>';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–∞ —Ü–µ–Ω—ã
        document.getElementById('setPriceLimitBtn')?.addEventListener('click', async function() {
            const priceLimit = document.getElementById('priceLimit').value;
            const resultDiv = document.getElementById('priceLimitResult');
            
            if (!priceLimit || priceLimit < 0) {
                resultDiv.innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ª–∏–º–∏—Ç —Ü–µ–Ω—ã</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ª–∏–º–∏—Ç...</p>';
            
            try {
                const response = await fetch('/api/admin/price-limit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ price_limit: parseFloat(priceLimit) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–∏–º–∏—Ç–∞ —Ü–µ–Ω—ã</p>';
            }
        });

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
        window.editParticipant = async function(participantId) {
            const modal = document.getElementById('editModal');
            const resultDiv = document.getElementById('editResult');
            resultDiv.innerHTML = '';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            try {
                const response = await fetch(`/api/admin/participant/${participantId}`);
                const data = await response.json();
                
                if (data.participant) {
                    document.getElementById('editParticipantId').value = data.participant.id;
                    document.getElementById('editName').value = data.participant.name;
                    document.getElementById('editEmail').value = data.participant.email;
                    document.getElementById('editWishlist').value = data.participant.wishlist || '';
                    modal.style.display = 'block';
                } else {
                    resultDiv.innerHTML = '<p class="error">–£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞</p>';
            }
        };

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editParticipantForm').reset();
            document.getElementById('editResult').innerHTML = '';
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('editParticipantForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const participantId = document.getElementById('editParticipantId').value;
            const name = document.getElementById('editName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const wishlist = document.getElementById('editWishlist').value.trim();
            const resultDiv = document.getElementById('editResult');
            
            if (!name || !email) {
                resultDiv.innerHTML = '<p class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</p>';
            
            try {
                const response = await fetch(`/api/admin/participant/${participantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        wishlist: wishlist
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeEditModal();
            }
        };
    </script>
    {% endif %}
</body>
</html>

